# .github/workflows/promote-staging.yml
name: Promote Staging to Main

on:
  schedule:
    - cron: '0 23 * * 1-5'  # 6pm EST weekdays (11pm UTC)
  workflow_dispatch:  # Manual trigger button

jobs:
  promote:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: staging
          fetch-depth: 0
          token: ${{ secrets.STAGING_PAT }}

      - name: Check if staging has new commits
        id: check
        run: |
          git fetch origin main --tags
          DIFF=$(git rev-list --count origin/main..staging)
          echo "Staging is $DIFF commits ahead of main"
          echo "commits_ahead=$DIFF" >> $GITHUB_OUTPUT

      - name: Calculate version bump from commits
        id: version
        if: steps.check.outputs.commits_ahead > 0
        run: |
          # Get last release tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Last tag: $LAST_TAG"

          # Get commits on staging since main (these are the commits being promoted)
          COMMITS=$(git log origin/main..staging --pretty=format:"%s")
          echo "Commits to be promoted:"
          echo "$COMMITS"

          # Check if any extension files actually changed
          EXTENSION_FILES=$(git diff --name-only origin/main..staging -- extension/ || true)
          echo "Extension files changed:"
          echo "$EXTENSION_FILES"

          if [ -z "$EXTENSION_FILES" ]; then
            echo "No extension files changed. Skipping version bump."
            echo "should_bump=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Filter out non-extension commits (chore, docs, landing page changes)
          # These don't trigger version bumps
          EXTENSION_COMMITS=$(echo "$COMMITS" | grep -vE "^(chore|docs|ci|style|refactor)(\(.+\))?:" | grep -vE "^(feat|fix)\(landing\):" || true)

          if [ -z "$EXTENSION_COMMITS" ]; then
            echo "Only chore/docs/landing commits. Skipping version bump."
            echo "should_bump=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Extension-relevant commits:"
          echo "$EXTENSION_COMMITS"

          # Determine bump type from extension commits only
          BUMP="patch"  # Default

          # Check for breaking changes (exclude landing scope)
          if echo "$EXTENSION_COMMITS" | grep -qE "^feat(\([^)]*\))?!:|BREAKING CHANGE:"; then
            BUMP="major"
            echo "Found breaking change - major bump"
          # Check for features (exclude landing scope)
          elif echo "$EXTENSION_COMMITS" | grep -qE "^feat(\([^)]*\))?:"; then
            BUMP="minor"
            echo "Found feat commit - minor bump"
          else
            echo "Default to patch bump"
          fi

          # Get current version from manifest (or from last tag)
          CURRENT=$(jq -r '.version' extension/manifest.json)
          echo "Current manifest version: $CURRENT"

          # Parse version components
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

          # Calculate new version
          case $BUMP in
            major)
              NEW_VERSION="$((MAJOR + 1)).0.0"
              ;;
            minor)
              NEW_VERSION="$MAJOR.$((MINOR + 1)).0"
              ;;
            patch)
              NEW_VERSION="$MAJOR.$MINOR.$((PATCH + 1))"
              ;;
          esac

          echo "New version: $NEW_VERSION (bump type: $BUMP)"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "bump_type=$BUMP" >> $GITHUB_OUTPUT
          echo "should_bump=true" >> $GITHUB_OUTPUT

      - name: Bump version on staging
        if: steps.check.outputs.commits_ahead > 0 && steps.version.outputs.should_bump == 'true'
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"

          # Update manifest.json
          jq ".version = \"$NEW_VERSION\"" extension/manifest.json > tmp.json
          mv tmp.json extension/manifest.json

          # Commit and push to staging (staging is not protected)
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add extension/manifest.json
          git commit -m "chore: bump version to $NEW_VERSION"
          git push origin staging

          echo "Bumped version to $NEW_VERSION on staging"

      - name: Check for existing PR
        id: existing_pr
        if: steps.check.outputs.commits_ahead > 0
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          EXISTING=$(gh pr list --base main --head staging --json number -q '.[0].number' || echo "")
          echo "existing_pr=$EXISTING" >> $GITHUB_OUTPUT

      - name: Create PR to main
        if: steps.check.outputs.commits_ahead > 0 && steps.existing_pr.outputs.existing_pr == ''
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: ${{ steps.version.outputs.new_version }}
          BUMP_TYPE: ${{ steps.version.outputs.bump_type }}
        run: |
          COMMITS=$(git log origin/main..staging --pretty=format:"- %s" | head -20)

          # Write body to temp file to avoid YAML parsing issues with colons
          cat > /tmp/pr_body.md << PREOF
          ## Automated promotion of staging changes

          **Version:** v${VERSION} (${BUMP_TYPE} bump)

          **Commits included**
          ${COMMITS}

          ---
          *This PR was created automatically by the promote-staging workflow.*
          PREOF

          gh pr create \
            --base main \
            --head staging \
            --title "Release v${VERSION}: Promote staging to main" \
            --body-file /tmp/pr_body.md

      - name: Enable auto-merge
        if: steps.check.outputs.commits_ahead > 0
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUM=$(gh pr list --base main --head staging --json number -q '.[0].number')
          if [ -n "$PR_NUM" ]; then
            gh pr merge $PR_NUM --merge --auto || echo "Auto-merge already enabled or PR not ready"
          fi

      - name: Summary
        run: |
          if [ "${{ steps.check.outputs.commits_ahead }}" = "0" ]; then
            echo "✅ Staging is up to date with main. Nothing to promote."
          elif [ "${{ steps.version.outputs.should_bump }}" = "false" ]; then
            echo "✅ Only chore/docs commits. PR created without version bump."
          else
            echo "✅ Bumped to v${{ steps.version.outputs.new_version }} and created PR to main."
          fi
