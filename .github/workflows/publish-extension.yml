 # .github/workflows/publish-extension.yml
  name: Publish Extension

  on:
    release:
      types: [published]
    workflow_dispatch:  # Manual trigger for hotfixes

  jobs:
    build-and-publish:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v4

        - name: Setup Node
          uses: actions/setup-node@v4
          with:
            node-version: '20'

        - name: Install dependencies
          run: npm ci

        - name: Run tests
          run: npm test

        - name: Build extension zip
          run: |
            cd extension
            zip -r ../patternpulse-${{ github.ref_name }}.zip . \
              -x "*.git*" -x "node_modules/*" -x "*.map"

        - name: Upload to Chrome Web Store
          uses: mnao305/chrome-extension-upload@v5.0.0
          with:
            file-path: patternpulse-${{ github.ref_name }}.zip
            extension-id: ${{ secrets.CHROME_EXTENSION_ID }}
            client-id: ${{ secrets.CHROME_CLIENT_ID }}
            client-secret: ${{ secrets.CHROME_CLIENT_SECRET }}
            refresh-token: ${{ secrets.CHROME_REFRESH_TOKEN }}
            publish: true  # Auto-publish after upload
