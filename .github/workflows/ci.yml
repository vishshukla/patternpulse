# .github/workflows/ci.yml
name: CI

on:
  pull_request:
    branches: [main, staging]

jobs:
  check-branch-name:
    runs-on: ubuntu-latest
    steps:
      - name: Check branch name
        run: |
          BRANCH="${{ github.head_ref }}"
          TARGET="${{ github.base_ref }}"
          echo "Source branch: $BRANCH"
          echo "Target branch: $TARGET"

          # Rules for PRs to main
          if [ "$TARGET" = "main" ]; then
            if [[ "$BRANCH" =~ ^(staging|hotfix/|release/) ]]; then
              echo "✅ Branch '$BRANCH' is allowed to merge to main"
            else
              echo "❌ Branch '$BRANCH' cannot merge to main"
              echo ""
              echo "Only these can merge to main:"
              echo "  - staging     (daily promotion)"
              echo "  - hotfix/*    (urgent production fixes)"
              echo "  - release/*   (manual releases)"
              exit 1
            fi
          fi

          # Rules for PRs to staging
          if [ "$TARGET" = "staging" ]; then
            if [[ "$BRANCH" =~ ^(feature/|fix/) ]]; then
              echo "✅ Branch '$BRANCH' is allowed to merge to staging"
            else
              echo "❌ Branch '$BRANCH' cannot merge to staging"
              echo ""
              echo "Only these can merge to staging:"
              echo "  - feature/*   (new features)"
              echo "  - fix/*       (bug fixes)"
              exit 1
            fi
          fi

  check-hotfix-version:
    runs-on: ubuntu-latest
    if: github.base_ref == 'main' && startsWith(github.head_ref, 'hotfix/')
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check version bump in hotfix
        run: |
          # Get version from PR branch
          PR_VERSION=$(jq -r '.version' extension/manifest.json)
          echo "PR version: $PR_VERSION"

          # Get version from main
          git fetch origin main
          MAIN_VERSION=$(git show origin/main:extension/manifest.json | jq -r '.version')
          echo "Main version: $MAIN_VERSION"

          # Compare versions
          if [ "$PR_VERSION" = "$MAIN_VERSION" ]; then
            echo ""
            echo "❌ Hotfix PRs must include a version bump!"
            echo ""
            echo "Current main version: $MAIN_VERSION"
            echo "Your PR version:      $PR_VERSION"
            echo ""
            echo "Please bump the version in extension/manifest.json"
            echo "Typically hotfixes are patch bumps (e.g., 0.9.3 → 0.9.4)"
            exit 1
          fi

          # Validate version is higher (simple string compare works for semver)
          echo "✅ Version bumped from $MAIN_VERSION to $PR_VERSION"

  run-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test
