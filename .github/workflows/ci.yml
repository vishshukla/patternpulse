# .github/workflows/ci.yml
name: CI

on:
  pull_request:
    branches: [main, staging]

jobs:
  check-branch-name:
    runs-on: ubuntu-latest
    steps:
      - name: Check branch name
        run: |
          BRANCH="${{ github.head_ref }}"
          TARGET="${{ github.base_ref }}"
          echo "Source branch: $BRANCH"
          echo "Target branch: $TARGET"

          # Rules for PRs to main
          if [ "$TARGET" = "main" ]; then
            if [[ "$BRANCH" =~ ^(staging|hotfix/|release/) ]]; then
              echo "✅ Branch '$BRANCH' is allowed to merge to main"
            else
              echo "❌ Branch '$BRANCH' cannot merge to main"
              echo ""
              echo "Only these can merge to main:"
              echo "  - staging     (daily promotion)"
              echo "  - hotfix/*    (urgent production fixes)"
              echo "  - release/*   (manual releases)"
              exit 1
            fi
          fi

          # Rules for PRs to staging
          if [ "$TARGET" = "staging" ]; then
            if [[ "$BRANCH" =~ ^(feature/|fix/) ]]; then
              echo "✅ Branch '$BRANCH' is allowed to merge to staging"
            else
              echo "❌ Branch '$BRANCH' cannot merge to staging"
              echo ""
              echo "Only these can merge to staging:"
              echo "  - feature/*   (new features)"
              echo "  - fix/*       (bug fixes)"
              exit 1
            fi
          fi

  run-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test
